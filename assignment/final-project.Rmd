---
title: "California ISO Electric Grid Data Analysis"
author: "Michaela Palmer & Melissa Ferriter"
output: github_document
---

```{r setup, include=T}
knitr::opts_chunk$set(echo = T, warning = F, message = F)
```

```{r results='hide'}
libs <- c("tidyverse", "readxl", "foreign", "zoo")
sapply(libs, require, character.only=T)
```

## Data preparation and reading

The data used in this analysis comes from [California Independent System Operator Corporation (CAISO)](http://www.caiso.com/green/renewableswatch.html), which aggregates grid data from electricity producers in California.

```{r}
# Create and view an object with file names & full paths
days <- c(paste0("0", 1:9), 10:25)
months <- c(paste0("0", 1:9), "10", "11", "12")

urls <- list()
for (i in months) {
  url <- paste0("http://content.caiso.com/green/renewrpt/2017", i, days,"_DailyRenewablesWatch.txt")
  urls[[paste0("month", i)]] <- url
}

```

We are going to be reading in the CAISO data by month for 2017. However, We have to be aware that this is unverified raw data that contains errors. 
Consequently, we chose to remove March 2017 due to the error: 

`"The supplied DateTime represents an invalid time. For example, when the clock is adjusted forward, any time in the period that is skipped is invalid."`

```{r }
# Function to import data with proper formatting & columns 
import <- function(data) {
  data.frame(date = as.Date(basename(data), "%Y%m%d"), read_table2( 
    data,
    col_names = c("hour", "geothermal", "biomass", "biogas", "small_hydro", "wind", "solar_pv", "solar_thermal" ),
    skip = 2,
    n_max = 24
  )) 
}

jan <- do.call("rbind", lapply(urls[["month01"]], import))
feb <- do.call("rbind", lapply(urls[["month02"]], import)) 
april <- do.call("rbind", lapply(urls[["month04"]], import)) 
may <- do.call("rbind", lapply(urls[["month05"]], import)) 
june <- do.call("rbind", lapply(urls[["month06"]], import))
july <- do.call("rbind", lapply(urls[["month07"]], import))
august <- do.call("rbind", lapply(urls[["month08"]], import))
oct <- do.call("rbind", lapply(urls[["month10"]], import))
nov <- do.call("rbind", lapply(urls[["month11"]], import))
```

When reading in the dates from the urls, we tested out other regular expressions methods to access the year, month, a day from the `.txt` file. 
These regex methods below work, but we decided to pursue the `as.Date` function in base R for sake of conciseness. 

```{r}
sub(".*(\\d{8}).*", "\\1", urls)
sub(".*/", "", sub("_.*", "", urls))
gsub("(?:.*/){4}([^_]+)_.*", "\\1", urls)
```

# Daily average data plots - By Season

The CAISO data are provided at hourly intervals. Plotting the data for each month the entire 6-year period would have generated an overwhelmig number of graphs, so we first wrote a funcntion to calculate daily means and plot them.

```{r}
#month.list <- list(January=jan, Febuary = feb, April=april, May=may, June=june, July=july, August=august, October=oct, November=nov)
plot <- function(data, name) {
  data[,-c(2)] %>%
    read.zoo(FUN = identity) %>%
    aggregate(as.Date, mean) %>%
    fortify.zoo() %>%
    select(Index, geothermal, biomass, biogas, small_hydro, wind, solar_pv, solar_thermal) %>%
    gather(Renewables, mean,-Index) %>%
    ggplot() +
    geom_line(mapping = aes(x = Index, y = mean, color = Renewables)) + 
    labs(title = paste(name, "2017 Daily Averages", sep = " "), x = "Date", y = "Generation (MW)") + theme_minimal() +
    theme(legend.position="bottom") + theme(plot.title = element_text(hjust=0.5))
}
#plot.list <- Map(plot, data = month.list, name = names(month.list))
#plot.list
```

We are going to categorize the months' data under the four seasons. 
Assumptions:

  - Jan-Feb = Winter
  - April-May = Spring 
  - June-Aug = Summer
  - Oct-Nov = Fall 

We aggregated the months by these seasonal assumptions and plotted them below. 

```{r}
winter <- bind_rows(jan, feb)
spring <- bind_rows(april, may)
summer <- bind_rows(june, july)
fall <- bind_rows(oct, nov)
season.list <- list(Winter=winter, Spring=spring, Summer=summer, Fall=fall)
Map(plot, data = season.list, name = names(season.list))
```

We can explore seasonality/time series analysis using these visualizations. 
Summer irradiance > winter,
Magnitude of generation is the least in Winter, to be expected. An interesting feature of these plots that wind generation peaks around mid-year and decreases to near-zero in the winter, just like solar only more pronounced. 


# Explore high-demand/peak periods during August and September.
(Compare with baseload)

```{r}

```

