---
title: "California ISO Electric Grid Data Analysis"
author: "Michaela Palmer & Melissa Ferriter"
output: github_document
---

```{r setup, include=T}
knitr::opts_chunk$set(echo = T, warning = F, message = F)
```

```{r results='hide'}
libs <- c("tidyverse", "readxl", "foreign", "zoo", "ggpubr", "cowplot", "gridExtra")
sapply(libs, require, character.only=T)
```

## Read in data

The data used in this analysis comes from [California Independent System Operator Corporation (CAISO)](http://www.caiso.com/green/renewableswatch.html), which aggregates grid data from electricity producers in California.

```{r}
# create and view an object with file names & full paths
days <- c(paste0("0", 1:9), 10:25)
months <- c(paste0("0", 1:9), "10", "11", "12")

urls <- list()
for (i in months) {
  url <- paste0("http://content.caiso.com/green/renewrpt/2017", i, days,"_DailyRenewablesWatch.txt")
  urls[[paste0("month", i)]] <- url
}

```

We are going to be reading in the CAISO data by month for 2017. However, We have to be aware that this is unverified raw data that contains errors. 
Consequently, we chose to remove March 2017 due to the error: "The supplied DateTime represents an invalid time.  For example, when the clock is adjusted forward, any time in the period that is skipped is invalid."

```{r }
# function to import data with proper formatting & columns 
import <- function(data) {
  data.frame(date = as.Date(basename(data), "%Y%m%d"), read_table2( 
    data,
    col_names = c("hour", "geothermal", "biomass", "biogas", "small_hydro", "wind", "solar_pv", "solar_thermal" ),
    skip = 2,
    n_max = 24
  )) 
}

jan <- do.call("rbind", lapply(urls[["month01"]], import))
feb <- do.call("rbind", lapply(urls[["month02"]], import)) 
april <- do.call("rbind", lapply(urls[["month04"]], import)) 
may <- do.call("rbind", lapply(urls[["month05"]], import)) 
june <- do.call("rbind", lapply(urls[["month06"]], import))
july <- do.call("rbind", lapply(urls[["month07"]], import))
august <- do.call("rbind", lapply(urls[["month08"]], import))
oct <- do.call("rbind", lapply(urls[["month10"]], import))
nov <- do.call("rbind", lapply(urls[["month11"]], import))
```

When reading in the dates from the urls, we tested out other regular expressions methods. 
These methods below work, but we decided to pursue a different method for sake of conciseness. 

```{r}
sub(".*(\\d{8}).*", "\\1", urls)
sub(".*/", "", sub("_.*", "", urls))
gsub("(?:.*/){4}([^_]+)_.*", "\\1", urls)
```

# Daily average data plots

The CAISO data are provided at hourly intervals. Plotting the data for the entire 6-year period would have generated a very messy graph, so we calculated daily means and plotted them.

```{r}
month.list <- list(January=jan, Febuary = feb, April=april, May=may, June=june, July=july, August=august, October=oct, November=nov)
plot <- function(data, name) {
  data[,-c(2)] %>%
    read.zoo(FUN = identity) %>%
    aggregate(as.Date, mean) %>%
    fortify.zoo() %>%
    select(Index, geothermal, biomass, biogas, small_hydro, wind, solar_pv, solar_thermal) %>%
    gather(Renewables, mean,-Index) %>%
    ggplot() +
    geom_line(mapping = aes(x = Index, y = mean, color = Renewables)) + 
    labs(title = paste(name, "2017 Daily Averages", sep = " "), x = "Date", y = "Generation (MW)") + theme_minimal()
}

plot.list <- Map(plot, data = month.list, name = names(month.list))
plot.list
```

We are going to further explore seasonality/time series anaylsis because summer irradiance > winter.
Assumptions:
  -Jan-Feb = Winter
  -April-May = Spring 
  -June-Aug = Summer
  -Oct-Nov = Fall 

```{r}

```

Next we are going to explore which sources have the most output during peak (Jan-Feb 4-9pm) and super peak (July-Aug 4-9pm) time frames.  We expect that some sources will maintain constant output, while others, such as solar, will experience varied output depending on month and time of day. 

```{r}
##vizualize how renewables change throughout the peak and super peak periods
pk <- rbind(jan, feb)
spk <- rbind(july, august)
peak <- pk[, -c(1)] %>%
    filter(hour >= 16, hour <= 21 ) %>%
    group_by(hour) %>%
    summarise_each(funs(mean)) %>%
    gather(Renewable, mean, -hour) %>%
    ggplot() +
    geom_line(mapping = aes(x = hour, y = mean, color = Renewable)) + 
    labs(title = "Peak Time Frame (Jan-Feb 4-9pm)", x = "Hour", y = "Generation (MW)") + theme_minimal()
super.peak <- spk[, -c(1)] %>%
    filter(hour >= 16, hour <= 21 ) %>%
    group_by(hour) %>%
    summarise_each(funs(mean)) %>%
    gather(Renewable, mean, -hour) %>%
    ggplot() +
    geom_line(mapping = aes(x = hour, y = mean, color = Renewable)) + 
    labs(title = "Super Peak Time Frame (July-August 4-9pm)", x = "Hour", y = "Generation (MW)") + theme_minimal()
ggarrange(peak + rremove("xlab") + rremove("x.text"), super.peak, nrow = 2, common.legend = TRUE)
```

```{r}
#compare the averages over the peak and super peak time frames for each renewable
peak.avg <- pk[, -c(1)] %>%
    filter(hour >= 16, hour <= 21 ) %>%
    select(geothermal, biomass, biogas, small_hydro, wind, solar_pv, solar_thermal) %>%
    summarise_each(funs(mean)) %>%
    gather(Renewable, PeakMean)
super.peak.avg <- spk[, -c(1)] %>%
    filter(hour >= 16, hour <= 21 ) %>%
    select(geothermal, biomass, biogas, small_hydro, wind, solar_pv, solar_thermal) %>%
    summarise_each(funs(mean)) %>%
    gather(Renewable, "Super Peak Mean")
final <- merge(peak.avg, super.peak.avg, by = "Renewable")
```

```{r}
#vizualization of Peak and Super Peak averages by renewable source
final %>%
  tidyr::gather(Time, Mean, -Renewable) %>%
  ggplot(aes(x = Renewable, y = Mean, fill = Time)) + geom_bar(stat="identity", position = "dodge") +
    scale_fill_brewer(palette="Set1") + guides(fill=guide_legend("Period")) + labs(
     title = "Comparison Peak and Super Peak Renewable Generation",
    x = "Renewable",
    y = "Generation (MW)"
  ) + theme(legend.position = "right", axis.text.x = element_text(angle = 45, hjust = 1), legend.text=element_text(size=7), legend.key.size = unit(.7, "line"), legend.title=element_text(size=10)) 
```

